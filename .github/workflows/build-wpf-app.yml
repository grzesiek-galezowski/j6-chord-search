name: Build WPF Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
    
      - name: Restore dependencies
        run: dotnet restore J6ChordSearcher.sln
    
      - name: Build and publish self-contained app
        run: dotnet publish J6ChordSearcher/J6ChordSearcher.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish
    
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: J6ChordSearcher-win-x64
          path: ./publish/*.exe
    
      - name: Delete old artifacts
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const artifactName = 'J6ChordSearcher-win-x64';
            const currentRunId = context.runId;
            
            // Get all artifacts with pagination
            let allArtifacts = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const response = await github.rest.actions.listArtifactsForRepo({
                owner: repo.owner,
                repo: repo.repo,
                per_page: 100,
                page: page
              });
              
              allArtifacts = allArtifacts.concat(response.data.artifacts);
              hasMore = response.data.artifacts.length === 100;
              page++;
            }
            
            // Filter artifacts with the same name
            const allMatchingArtifacts = allArtifacts
              .filter(artifact => artifact.name === artifactName)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Check if current run's artifact is in the list
            const currentRunArtifactExists = allMatchingArtifacts.some(
              artifact => artifact.workflow_run && artifact.workflow_run.id === currentRunId
            );
            
            // If current run's artifact exists, delete all others
            // If not, keep the most recent one (it's the "last successful version" until the new one is available)
            const artifactsToDelete = currentRunArtifactExists
              ? allMatchingArtifacts.filter(artifact => !artifact.workflow_run || artifact.workflow_run.id !== currentRunId)
              : allMatchingArtifacts.slice(1); // Keep the most recent, delete the rest
            
            console.log(`Found ${allMatchingArtifacts.length} artifacts named '${artifactName}'`);
            console.log(`Current run artifact exists: ${currentRunArtifactExists}`);
            console.log(`Will delete ${artifactsToDelete.length} old artifact(s)`);
            
            // Delete old artifacts
            for (const artifact of artifactsToDelete) {
              console.log(`Deleting artifact ID: ${artifact.id}, created at: ${artifact.created_at}`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: repo.owner,
                  repo: repo.repo,
                  artifact_id: artifact.id
                });
              } catch (error) {
                console.log(`Failed to delete artifact ${artifact.id}: ${error.message}`);
              }
            }
            
            console.log('Artifact cleanup completed.');
