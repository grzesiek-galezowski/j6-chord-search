name: Build WPF Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
    
      - name: Restore dependencies
        run: dotnet restore J6ChordSearcher.sln
    
      - name: Build and publish self-contained app
        run: dotnet publish J6ChordSearcher/J6ChordSearcher.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish
    
      - name: Upload artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: J6ChordSearcher-win-x64
          path: ./publish/*.exe
    
      - name: Delete old artifacts
        if: success() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const artifactName = 'J6ChordSearcher-win-x64';
            const artifactIdString = '${{ steps.upload-artifact.outputs.artifact-id }}';
            const currentArtifactId = parseInt(artifactIdString, 10);
            
            console.log(`Artifact ID string: ${artifactIdString}`);
            console.log(`Current artifact ID: ${currentArtifactId}`);
            
            // Validate artifact ID
            if (isNaN(currentArtifactId) || currentArtifactId <= 0) {
              console.error('Failed to get valid artifact ID from upload step');
              throw new Error('Invalid artifact ID: must be a positive integer');
            }
            
            // Get all artifacts with pagination
            let allArtifacts = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const response = await github.rest.actions.listArtifactsForRepo({
                owner: repo.owner,
                repo: repo.repo,
                per_page: 100,
                page: page
              });
              
              allArtifacts = allArtifacts.concat(response.data.artifacts);
              hasMore = response.data.artifacts.length === 100;
              page++;
            }
            
            // Filter artifacts with the same name, excluding the current one
            const artifactsToDelete = allArtifacts
              .filter(artifact => artifact.name === artifactName && artifact.id !== currentArtifactId)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            console.log(`Found ${artifactsToDelete.length} old artifact(s) to delete`);
            
            // Delete all old artifacts
            for (const artifact of artifactsToDelete) {
              console.log(`Deleting artifact ID: ${artifact.id}, created at: ${artifact.created_at}`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: repo.owner,
                  repo: repo.repo,
                  artifact_id: artifact.id
                });
              } catch (error) {
                console.log(`Failed to delete artifact ${artifact.id}: ${error.message}`);
              }
            }
            
            console.log('Artifact cleanup completed.');
