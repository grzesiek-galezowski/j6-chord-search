name: Build WPF Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore J6ChordSearcher.sln
    
    - name: Build and publish self-contained app
      run: dotnet publish J6ChordSearcher/J6ChordSearcher.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: J6ChordSearcher-win-x64
        path: ./publish/*.exe
    
    - name: Delete old artifacts
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const repo = context.repo;
          
          // Get all artifacts
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: repo.owner,
            repo: repo.repo,
            per_page: 100
          });
          
          // Filter artifacts with the same name
          const artifactName = 'J6ChordSearcher-win-x64';
          const matchingArtifacts = artifacts.data.artifacts
            .filter(artifact => artifact.name === artifactName)
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          
          // Keep only the latest artifact, delete the rest
          if (matchingArtifacts.length > 1) {
            console.log(`Found ${matchingArtifacts.length} artifacts named '${artifactName}'`);
            console.log(`Keeping the latest artifact (ID: ${matchingArtifacts[0].id})`);
            
            for (let i = 1; i < matchingArtifacts.length; i++) {
              const artifact = matchingArtifacts[i];
              console.log(`Deleting artifact ID: ${artifact.id}, created at: ${artifact.created_at}`);
              await github.rest.actions.deleteArtifact({
                owner: repo.owner,
                repo: repo.repo,
                artifact_id: artifact.id
              });
            }
          } else {
            console.log(`Only one artifact found, nothing to delete.`);
          }
